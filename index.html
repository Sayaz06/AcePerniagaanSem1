<!-- index.html -->
<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SubjekNota</title> <!-- â† tukar tajuk browser -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="Perniagaanicon-192.png"> <!-- â† tukar icon app -->

<style>
/* (Skrip CSS sama seperti asal) */
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“š SubjekNota</h1>

<div class="header-controls">
<input id="import-json" type="file" accept="application/json" class="import-file-input">
<button id="import-json-btn">ðŸ“¥ Import JSON</button>
<button id="export-json-btn">ðŸ“¤ Export JSON</button>
<button id="clear-all-btn" style="background:#ff8c00;color:#fff">ðŸ§¹ Kosongkan</button>
</div>

<hr>

<button id="add-title-btn">âž• Tambah Tajuk</button>
<div id="notes-container" class="children-container"></div>
<p class="muted">Semua data disimpan dalam localStorage & boleh digunakan offline.</p>
</div>

<script>
const notesContainer=document.getElementById('notes-container');
const addTitleBtn=document.getElementById('add-title-btn');
const exportBtn=document.getElementById('export-json-btn');
const importInput=document.getElementById('import-json');
const importBtn=document.getElementById('import-json-btn');
const clearBtn=document.getElementById('clear-all-btn');

/* ---------- CREATE ENTRY ---------- */
function createSubjectEntry(level, numbering='', titleText='', bmNote='', otherNote=''){
    const entry=document.createElement('div');
    entry.className=`subject-entry level-${level}`;
    entry.dataset.level=level;
    entry.dataset.numbering=numbering;

    const titleLabel=document.createElement('div');
    titleLabel.className='title-text'; titleLabel.contentEditable=true;
    titleLabel.innerText=numbering?numbering+'. '+titleText:titleText||(level===1?'Tajuk Besar Baru':'Subtopik Baru Peringkat '+level);

    const titleBar=document.createElement('div'); titleBar.className='title-bar';
    const controls=document.createElement('div'); controls.className='title-controls';
    const addSubBtn=document.createElement('button'); addSubBtn.className='add-subtopic-btn'; addSubBtn.textContent='âž• Subtopik';
    addSubBtn.dataset.level=level;
    const delBtn=document.createElement('button'); delBtn.className='delete-btn'; delBtn.textContent='âŒ Padam';
    controls.appendChild(addSubBtn); controls.appendChild(delBtn);
    titleBar.appendChild(titleLabel); titleBar.appendChild(controls);
    entry.appendChild(titleBar);

    if(level>1){
        const notes=document.createElement('div'); notes.className='notes-area';
        notes.innerHTML=`
        <div class="note-section">
            <label>Nota (BM):</label>
            <div class="textarea-wrapper">
                <textarea class="bm-note">${bmNote}</textarea>
                <div class="drag-handle"></div>
            </div>
        </div>
        <div class="note-section">
            <label>Nota (Bahasa Kedua):</label>
            <div class="textarea-wrapper">
                <textarea class="other-note">${otherNote}</textarea>
                <div class="drag-handle"></div>
            </div>
        </div>`;
        entry.appendChild(notes);
    }

    const childContainer=document.createElement('div'); childContainer.className='children-container';
    entry.appendChild(childContainer);

    entry.querySelectorAll('textarea').forEach(t=>t.addEventListener('input',saveToLocal));
    titleLabel.addEventListener('blur',saveToLocal);
    return entry;
}

/* ---------- DRAG HANDLE ---------- */
/* (Skrip sama seperti asal) */

/* ---------- NUMBERING ---------- */
function updateNumbering(container,prefix=''){
    // Kosongkan numbering automatik supaya pengguna boleh masukkan sendiri
    [...container.children].filter(c=>c.classList.contains('subject-entry')).forEach(c=>{
        c.dataset.numbering=''; 
        const titleEl=c.querySelector('.title-text');
        const text=titleEl.innerText.replace(/^\d+(\.\d+)*\.\s*/, '');
        titleEl.innerText=text;
        updateNumbering(c.querySelector('.children-container'));
    });
}

/* ---------- SAVE / LOAD ---------- */
function treeToJson(container){return [...container.children].filter(c=>c.classList.contains('subject-entry')).map(c=>({
    level:Number(c.dataset.level),
    numbering:c.dataset.numbering,
    title:c.querySelector('.title-text').innerText,
    bm:c.querySelector('.bm-note')?.value||'',
    other:c.querySelector('.other-note')?.value||'',
    children:treeToJson(c.querySelector('.children-container'))
}));}

function jsonToTree(arr,container){arr.forEach(item=>{
    const cleanTitle=item.title.replace(/^\d+(\.\d+)*\.\s*/, ''); // â† remove auto-number semasa load
    const entry=createSubjectEntry(item.level,item.numbering,cleanTitle,item.bm,item.other);
    container.appendChild(entry);
    if(item.children?.length) jsonToTree(item.children,entry.querySelector('.children-container'));
}); setupResizeHandles(); }

function saveToLocal(){localStorage.setItem('subjek-nota-data',JSON.stringify(treeToJson(notesContainer)));}
function loadFromLocal(){const raw=localStorage.getItem('subjek-nota-data'); if(!raw) return; notesContainer.innerHTML=''; jsonToTree(JSON.parse(raw),notesContainer); /* updateNumbering(notesContainer); â†’ tak perlu lagi */}

/* ---------- EVENTS ---------- */
addTitleBtn.onclick=()=>{notesContainer.appendChild(createSubjectEntry(1,'','Tajuk Baru')); setupResizeHandles();} // numbering dikosongkan, manual

notesContainer.onclick=e=>{
    const target=e.target;
    if(target.classList.contains('add-subtopic-btn')){
        const parent=target.closest('.subject-entry');
        const level=Number(parent.dataset.level); if(level>=9){alert('Maksimum 9 peringkat!'); return;}
        const childContainer=parent.querySelector('.children-container');
        childContainer.appendChild(createSubjectEntry(level+1,'','Subtopik Baru')); // numbering kosong, manual
        setupResizeHandles();
    }
    if(target.classList.contains('delete-btn')){
        if(confirm('Padam entri ini beserta subtopik?')){
            target.closest('.subject-entry').remove();
            saveToLocal();
        }
    }
}

/* ---------- IMPORT / EXPORT ---------- */
importBtn.onclick=()=>importInput.click();
importInput.onchange=evt=>{
    const file=evt.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            const json=JSON.parse(e.target.result);
            notesContainer.innerHTML='';
            jsonToTree(json,notesContainer);
            saveToLocal();
            setupResizeHandles();
            alert('Import berjaya!');
        }catch(err){alert('Fail JSON tidak sah! '+err.message);}
    };
    reader.readAsText(file);
    evt.target.value='';
}

exportBtn.onclick=()=>{
    const blob=new Blob([JSON.stringify(treeToJson(notesContainer),null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='AcePerniagaan1.json'; a.click(); URL.revokeObjectURL(url); // â† tukar nama file manifest
}

/* ---------- CLEAR ---------- */
clearBtn.onclick=()=>{if(confirm('Kosongkan semua nota?')){notesContainer.innerHTML=''; localStorage.removeItem('subjek-nota-data');}}

/* ---------- INIT ---------- */
loadFromLocal();
setupResizeHandles();

/* ---------- SERVICE WORKER ---------- */
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js'); // <-- PWA
</script>

</body>
  </html>
